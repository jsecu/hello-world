<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Web Cache Poisoning to Account Takeover | JSECU</title><meta name="description" content="JSECU"><meta itemprop="name" content="JSECU"><meta itemprop="description" content="JSECU"><meta itemprop="image" content="http://localhost:4000/images/yingyang.jpg"><meta property="og:url" content="http://localhost:4000/2021/02/21/poisoning/"><meta property="og:type" content="website"><meta property="og:title" content="Web Cache Poisoning to Account Takeover | JSECU"><meta property="og:site_name" content="JSECU"><meta property="og:description" content="JSECU"><meta property="og:image" content="http://localhost:4000/images/yingyang.jpg"><meta name="twitter:url" content="http://localhost:4000/2021/02/21/poisoning/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Web Cache Poisoning to Account Takeover | JSECU"><meta name="twitter:site" content="JSECU"><meta name="twitter:description" content="JSECU"><meta name="twitter:creator" content="@Pullerze"><meta property="twitter:image" content="http://localhost:4000/images/yingyang.jpg"><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link rel="stylesheet" href="/assets/css/app.min.css"><link rel="alternate" type="application/rss+xml" title="JSECU" href="/feed.xml"><link rel="canonical" href="/2021/02/21/poisoning/"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'n', 'auto'); ga('send', 'pageview'); </script></head><body id="web-cache-poisoning-to-account-takeover" class="post-layout"><header class="header"> <a class="header__title" href="http://localhost:4000/">JSECU</a><nav><ul class="header__list"><li><a href="/">Posts</a></li><li><a href="/about">About</a></li></ul></nav></header><main class="ðŸ’ˆ"><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Web Cache Poisoning to Account Takeover</h2><time class="post__date" datetime="2021-02-21T17:40:20-05:00" itemprop="datePublished">21 Feb 2021</time></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p><img src="../../../../../images/yingyang.jpg" /></p><p>Starting off,this is a vulnerability that I found during a bug bounty engagement.I would split this into two parts, or two separate vulnerabilities. The First part was a web cache poisoning via X Headers.This part allowed me to achieve XSS on every endpoint with a combination of two Headers.The next part was a Oauth flow flaw that allowed me to leverage my previously given XSS capabilities into an account takeover through a technique I call cookie overriding.Before I begin explaining this exploit chain, I have to say that since this is a private program I canâ€™t disclose the site that it was found on.</p><p>Web Cache Poisoning:</p><p>This vulnerability is well documented on Portswigger by James Kettle, and this is where I had first heard about so for a more in-depth introduction,I recommend reading that article.However for a quick primer,web cache poisoning is a vulnerability that allows an attacker to poison a HTTP response by injecting a malicious code into a non keyed HTTP request header. A web Cache is basically a way for websites to lower the load on their servers by replaying resources to users without asking the server.They look for specific keys in the the HTTP request to determine if they have already cached the resource and if they have, thatâ€™s what any user that matches that request gets served.These cache keys could be anything ranging from the URI to the Accept HTTP headers.However there are certain HTTP request headers that are not keyed and can introduce reflected output onto a HTTP response depending on the code implemented. A popular one and the one thatâ€™ll be exploited in this report is the X-Forwarded-Host header.This header can populated with a XSS payload and used to reflect a XSS payload into a HTTP response. After the cache gets this response and saves it without the unkeyed header, you can consider the cache poisoned and it will pass the response to every user that visits that URL.Thatâ€™s the basis of the attack, but this can be supplemented with another unkeyed header to increase the severity so that you can poison the cache for every URL on the site. This Header is the X-Rewrite-Url header, and this basically rewrites the URN that is being cached. So lets say the URN in a HTTP request is /home, the cache thinks its saving this HTTP response. But if you add the X-Rewrite-Url header, itâ€™ll actually load the malicious HTTP response at /evil.The header is usually unkeyed so itâ€™ll serve the poisoned response to any user that requests for /home.</p><p><img src="../../../../../images/web_cache_poisoning.png" /></p><p>The Exploit Chain(part 1):</p><p>What happened is that I found a site that supports both of these headers and had a page that reflected the X-Forwarded-Host header in a JavaScript variable on one of its pages.Using the combination of the X-Forwarded Host and the X-Rewrite-Url headers I was able to gain XSS on every page on the site without user interaction.However it was really only cached for about 3 minutes.To increase the severity I made a script to automate the poisoning, stating that I could just poison the home page endpoint every 3 minutes to infect every user that visits the site.However the team that the report was submitted to wanted to keep it a medium severity.This wasnâ€™t something I was trying to see so I went looking for another way to increase the severity. Which leads me to the second portion of this post, an Account takeover due to a flaw in their Oauth Flow.</p><p>Oauth Flaw:</p><p>If you not familiar with Oauth, this section will cover the flow of an Authorization Grant which was the grant used in this case. There are four major entities to this grant,the Client, the User, the Authorization server and the Resource Provider.The first step is the User requests access to a Resource.The Oauth Client sees this request and redirects the user to the Authorization server.The User validates their credentials with the Authorization server and if approved, gets an access code. After this the User is redirected back to the client and the client takes this code.The Client then takes this code and validates it with the Authorization server and finally gets an access token. This access token is used to retrieve data from the Resource Provider on behalf of the user. The issue on this site was after the code was sent back it was processed by an URL which took a value in a cookie that was another trusted OAuth callback URL and appended the code after a hash fragment to the value in the cookie and redirected the browser to this location.This allows for anyone that changes the cookie value to redirect the code to an arbitrary location.After that the attacker could just submit the code to the Authorization server and get a access token on behalf of the targeted user.</p><p><img src="../../../../../images/oauth_auth_code.png" /></p><p>Cookie Overriding: Normally this wouldnâ€™t be a issue due to two factors,the cookie was HTTPOnly and number two, the URL in the cookie was whitelisted to only trusted sites.The second problem was already solved in my case, since the cache poisoning XSS was already on a trusted subdomain. The first problem was the problem that had to get solved.How do you use a XSS to change a cookie value thatâ€™s HTTPOnly? The answer is that you donâ€™t, you make a cookie that looks like the HTTPOnly cookie, and set the path parameter to a certain URN where the cookie was being used.If a browser sees two cookies of the same name, but one has a more specified path, when a HTTP request to that path is requested, itâ€™ll choose precedence to the cookie with the specific path.With this I could craft a cookie on the poisoned subdomain using the XSS ,this cookies would work for all subdomains below the root domain and it would set the specific path to the path that initiated the URL in the cookie value.</p><p>Exploit Chain(Part 2):</p><p>After assembling all the parts, the global poisoned XSS ,the cookie overriding, and the OAuth flaw the question is how do I put these all together and actually takeover accounts.This is the exploit chain I came up with.Taking in consideration the time constraint, first I poisoned two endpoints. The first endpoint had the XSS payload and was located on the main page of the site. It wrote the malicious cookie to the userâ€™s browser, then redirected the browser to the OAuth flow. The second poisoned endpoint was located on a nonexistent endpoint thatâ€™s 404 response code was overridden with the poisoned response. This endpoint handled the callback from the redirected URL that was inserted in the cookie.This URL contained the code from the Oauth flow, and after receiving the code, the payload used another document.location to send the code off to the attackerâ€™s site in a query string. On the endpoint on the attackerâ€™s site I added another document.location after logging the URL and the code,to send the userâ€™s browserâ€™s back to one of the siteâ€™s regular pages. This whole process took about 5 secs to execute and avoided the time constraint.</p><p>Conclusion:</p><p>This was reported on HackerOne and the severity was boosted to a critical.</p><p>References:</p><p><a href="https://portswigger.net/research/practical-web-cache-poisoning">https://portswigger.net/research/practical-web-cache-poisoning</a></p><ul><li>Connect with me on :Twitter @Pullerze</li></ul></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Web Cache Poisoning to Account Takeover+http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://plus.google.com/share?url=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-google-plus"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Web Cache Poisoning to Account Takeover&summary=&url=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.stumbleupon.com/badge/?url=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-stumbleupon"></i></a></li><li><a href="https://www.reddit.com/submit?url=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li><li><a href="https://www.tumblr.com/share/link?url=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-tumblr"></i></a></li><li><a href="https://www.pinterest.com/pin/create/link/?description=&media=http://localhost:4000/images/yingyang.jpg&url=http://localhost:4000/2021/02/21/poisoning/" target="_blank"><i class="fa fa-pinterest"></i></a></li></ul></div></div></article></div></main><footer class="footer section-padding"><div class="grid"><div class="subscribe" id="subscribe"><div class="subscribe__container"> <span class="subscribe__title">JSECU</span><p class="subscribe__text">Enjoy your stay</p></div></div><hr class="sep--white"/><div class="footer__container"><ul class="footer__tags"></ul><ul class="footer__social"><li><a href="https://twitter.com/Pullerze" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="" target="_blank"><i class="fa fa-instagram"></i></a></li><li><a href="" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://github.com/jsecu" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="" target="_blank"><i class="fa fa-codepen"></i></a></li></ul></div></div></footer><section class="contact popup"><div class="popup__close"><div class="popup__exit"></div></div><div class="contact__container popup__container"><div class="contact__img"><figure class="absolute-bg" style="background-image: url(/assets/images/placeholder-28.jpg);"></figure></div><div class="contact__content"><div class="contact__mast section-padding--half"><div class="grid"><h2>Cont</h2></div></div><div class="section-padding--none"><hr class="sep"/></div><div class="contact__form section-padding--half"><div class="grid-xlarge"> <form id="form" class="form" action="" method="POST"><div class="form__subcontainer"><div> <label for="form-first-name">First Name</label> <input type="text" name="first-name" id="form-first-name" required></div><div> <label for="form-last-name">Last Name</label> <input type="text" name="last-name" id="form-last-name" required></div></div><div> <label for="form-email">E-Mail</label> <input type="email" name="email" id="form-email" required></div><div> <label for="form-message">Message</label> <textarea name="message" id="form-message" rows="3"></textarea></div><div class="form__submit"><div class="form__btn"> <input type="submit" value="Send"></div></div><p class="form__message"></p></form></div></div></div></div></section><script src="/assets/js/app.min.js"></script></body></html>
  